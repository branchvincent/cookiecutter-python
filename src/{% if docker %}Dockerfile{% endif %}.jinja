FROM python:3.9-alpine AS base
WORKDIR /app

### Builder ###
FROM base AS builder

# Install deps
RUN pip install --no-cache-dir pdm~=1.6
COPY pyproject.toml pdm.lock ./
RUN pdm install --prod --no-lock --no-editable --no-self

# Add source
COPY . .
RUN pdm install --prod --no-lock --no-editable

### Runner ###
FROM base AS runner
COPY --from=builder /app/__pypackages__/3.9 .
ENV PATH="/app/bin:$PATH"
ENV PYTHONPATH=/app/lib
ENTRYPOINT ["python", "-m", "{{project_name}}"]
CMD ["--help"]
